<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel Power BI - Curriculariza√ß√£o</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      background-color: #f5f7fa;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      color: #333;
    }
    header {
      background: linear-gradient(90deg, #0057b8, #0073e6);
      color: #fff;
      text-align: center;
      padding: 1rem 0.5rem;
      font-size: 1.5rem;
      font-weight: 600;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
      letter-spacing: 0.5px;
    }
    main {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
      position: relative;
    }
    #reportContainer {
      width: 90%;
      height: 80vh;
      border-radius: 16px;
      background-color: #fff;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
      overflow: hidden;
    }
    #status {
      position: absolute;
      top: 2rem;
      font-size: 1.2rem;
      background: #fff9c4;
      padding: 10px 20px;
      border-radius: 8px;
      color: #665c00;
      border: 1px solid #e6d267;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      display: none;
    }
    footer {
      background-color: #f0f0f0;
      text-align: center;
      padding: 0.7rem;
      font-size: 0.9rem;
      color: #666;
      box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.1);
    }
    .btn-imprimir {
      position: absolute;
      bottom: 2rem;
      right: 2rem;
      background: #0057b8;
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 1.5rem;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>

<body>
  <header>üìä Painel de Curriculariza√ß√£o - Power BI</header>

  <main>
    <div id="status">Aguarde, seu resultado fica pronto em breve...</div>
    <div id="reportContainer"></div>
    <button id="printButton" class="btn-imprimir" title="Imprimir relat√≥rio">üñ®Ô∏è</button>
  </main>

  <footer>
    Desenvolvido com ‚ù§Ô∏è usando Power BI Embedded
  </footer>

<script src="https://cdn.jsdelivr.net/npm/powerbi-client/dist/powerbi.min.js"></script>
<script>
(async function() {
  const statusEl = document.getElementById("status");
  const reportContainer = document.getElementById("reportContainer");
  const codigo = new URLSearchParams(window.location.search).get('codigo');

  if (!codigo) {
    console.warn("Nenhum ?codigo= na URL");
    return;
  }

  try {
    const res = await fetch('/api/embed-token');
    const data = await res.json();
    const models = window['powerbi-client'].models;

    const embedConfig = {
      type: 'report',
      id: data.reportId,
      embedUrl: data.embedUrl,
      accessToken: data.embedToken,
      tokenType: models.TokenType.Embed,
      settings: {
        panes: {
          filters: { visible: false },
          pageNavigation: { visible: true }
        }
      }
    };

    const powerbiService = new window['powerbi-client'].service.Service(
      window['powerbi-client'].factories.hpmFactory,
      window['powerbi-client'].factories.wpmpFactory,
      window['powerbi-client'].factories.routerFactory
    );

    const report = powerbiService.embed(reportContainer, embedConfig);

    async function applyCodigoFilter() {
      const filtro = new models.BasicFilter(
        { table: "respostas", column: "Codigo" },
        "In",
        [codigo]
      );
      await report.updateFilters(models.FiltersOperations.Replace, [filtro]);
      console.log("updateFilters() chamado com BasicFilter:", filtro);
    }

    async function logReportFilters() {
      try {
        const filters = await report.getFilters();
        console.log("report.getFilters():", filters);
      } catch (e) {
        console.warn("Erro ao getFilters():", e);
      }
    }

    async function inspectVisualsExport() {
      const pages = await report.getPages();
      const page = pages[0];
      const visuals = await page.getVisuals();

      console.log("Visuals list:", visuals.map(v => ({
        name: v.name, type: v.type, title: v.title
      })));

      const results = [];

      for (const v of visuals) {
        console.log(`--- visual: ${v.name} (type=${v.type}) ---`);

        // üî• CORRE√á√ÉO AQUI: incluir tableEx
        if (!["tableEx", "matrix", "table"].includes(v.type)) {
          console.log(`Skip export for visual type="${v.type}"`);
          results.push({ visualName: v.name, type: v.type, exported: false });
          continue;
        }

        try {
          const exported = await v.exportData(models.ExportDataType.Summarized, 500);
          const raw = exported?.data || "";
          const linhas = raw.trim() === "" ? [] : raw.trim().split("\n");

          results.push({
            visualName: v.name,
            type: v.type,
            exported: true,
            linhasCount: linhas.length,
            sample: linhas.slice(0, 5)
          });

        } catch (err) {
          console.warn(`exportData failed for visual "${v.name}":`, err);
          results.push({ visualName: v.name, type: v.type, exported: false, error: err });
        }
      }

      return results;
    }

    report.on("loaded", async () => {
      console.log("EVENT loaded");
      statusEl.style.display = "block";
      statusEl.innerText = "inspecionando...";

      await applyCodigoFilter();
      await logReportFilters();
    });

    let polling = true;
    let attempts = 0;
    const maxAttempts = 40;
    const intervalMs = 3000;

    async function checkOnce() {
      attempts++;
      console.log(`\n=== checkOnce attempt #${attempts} ===`);

      try {
        const filterState = await report.getFilters();
        console.log("Current report filters:", filterState);
      } catch(e) {}

      const visualsReport = await inspectVisualsExport();

      const anyData = visualsReport.some(r =>
        r.exported && r.linhasCount > 1
      );

      console.log("anyData?", anyData);

      if (anyData) {
        statusEl.style.display = "none";
        polling = false;
        return;
      } else {
        statusEl.style.display = "block";
        statusEl.innerText = "Aguarde, seu resultado fica pronto em breve...";
      }
    }

    report.on("rendered", async () => {
      console.log("EVENT rendered");
      await checkOnce();

      const pollLoop = setInterval(async () => {
        if (!polling) {
          clearInterval(pollLoop);
          return;
        }
        if (attempts >= maxAttempts) {
          statusEl.style.display = "block";
          statusEl.innerText = "Aguarde, seu resultado fica pronto em breve... (timeout)";
          clearInterval(pollLoop);
          return;
        }
        await checkOnce();
      }, intervalMs);
    });

    report.on("error", e => {
      console.error("PowerBI embed error:", e);
      statusEl.style.display = "block";
      statusEl.innerText = "Erro ao carregar (ver console).";
    });

  } catch (err) {
    console.error("Erro no embedReport:", err);
    statusEl.style.display = "block";
    statusEl.innerText = "Erro ao iniciar a visualiza√ß√£o.";
  }
})();
</script>

</body>
</html>
