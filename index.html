<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel Power BI - Curriculariza√ß√£o</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      background-color: #f5f7fa;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      color: #333;
    }
    header {
      background: linear-gradient(90deg, #0057b8, #0073e6);
      color: #fff;
      text-align: center;
      padding: 1rem 0.5rem;
      font-size: 1.5rem;
      font-weight: 600;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
      letter-spacing: 0.5px;
    }
    main {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
      position: relative;
    }
    #reportContainer {
      width: 90%;
      height: 80vh;
      border-radius: 16px;
      background-color: #fff;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
      overflow: hidden;
    }
    #status {
      position: absolute;
      top: 2rem;
      font-size: 1.2rem;
      background: #fff9c4;
      padding: 10px 20px;
      border-radius: 8px;
      color: #665c00;
      border: 1px solid #e6d267;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      display: none;
    }
    footer {
      background-color: #f0f0f0;
      text-align: center;
      padding: 0.7rem;
      font-size: 0.9rem;
      color: #666;
      box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.1);
    }
    .btn-imprimir {
      position: absolute;
      bottom: 2rem;
      right: 2rem;
      background: #0057b8;
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 1.5rem;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>

<body>
  <header>üìä Painel de Curriculariza√ß√£o - Power BI</header>

  <main>
    <div id="status">Aguarde, seu resultado fica pronto em breve...</div>
    <div id="reportContainer"></div>
    <button id="printButton" class="btn-imprimir" title="Imprimir relat√≥rio">üñ®Ô∏è</button>
  </main>

  <footer>
    Desenvolvido com ‚ù§Ô∏è usando Power BI Embedded
  </footer>

<script src="https://cdn.jsdelivr.net/npm/powerbi-client/dist/powerbi.min.js"></script>
<script>
(async function() {
  const statusEl = document.getElementById("status");
  const reportContainer = document.getElementById("reportContainer");
  const codigo = new URLSearchParams(window.location.search).get('codigo');

  if (!codigo) {
    console.warn("Nenhum ?codigo= na URL");
    return;
  }

  try {
    // 1) get embed token / config
    const res = await fetch('/api/embed-token');
    const data = await res.json();
    const models = window['powerbi-client'].models;

    const embedConfig = {
      type: 'report',
      id: data.reportId,
      embedUrl: data.embedUrl,
      accessToken: data.embedToken,
      tokenType: models.TokenType.Embed,
      settings: { panes: { filters: { visible: false }, pageNavigation: { visible: true } } }
    };

    // 2) embed
    const powerbiService = new window['powerbi-client'].service.Service(
      window['powerbi-client'].factories.hpmFactory,
      window['powerbi-client'].factories.wpmpFactory,
      window['powerbi-client'].factories.routerFactory
    );
    const report = powerbiService.embed(reportContainer, embedConfig);

    // helper: apply filter using BasicFilter (ensures filterType set)
    async function applyCodigoFilter() {
      const filtro = new models.BasicFilter(
        { table: "respostas", column: "Codigo" },
        "In",
        [codigo]
      );
      await report.updateFilters(models.FiltersOperations.Replace, [filtro]);
      console.log("updateFilters() chamado com BasicFilter:", filtro);
    }

    // helper: inspect current report filters
    async function logReportFilters() {
      try {
        const filters = await report.getFilters();
        console.log("report.getFilters():", filters);
      } catch (e) {
        console.warn("Erro ao getFilters():", e);
      }
    }

    // helper: get visuals metadata and try exportData; returns object with results
    async function inspectVisualsExport() {
      const pages = await report.getPages();
      console.log("Pages:", pages.map(p => ({name:p.name, displayName:p.displayName})));
      const page = pages[0];
      const visuals = await page.getVisuals();
      console.log("Visuals list:", visuals.map(v=>({name:v.name, type:v.type, title:v.title, id:v.getLayout ? v.getLayout().id : v.name})));

      const results = [];
      for (const v of visuals) {
        console.log(`--- visual: name="${v.name}" type="${v.type}" title="${v.title || ''}" ---`);
        // Only attempt export for visuals that are likely to export rows
        if (!["table","matrix"].includes(v.type)) {
          console.log(`Skip export for visual type="${v.type}"`);
          results.push({ visualName: v.name, type: v.type, exported: false, reason: "not exportable type" });
          continue;
        }

        try {
          // request summarized up to 500 rows
          const exported = await v.exportData(models.ExportDataType.Summarized, 500);
          console.log(`exportData result for visual "${v.name}":`, exported);
          const raw = exported?.data || "";
          const linhas = raw.trim() === "" ? [] : raw.trim().split("\n");
          console.log(`Parsed CSV lines for "${v.name}":`, linhas.length, linhas.slice(0,5));
          results.push({ visualName: v.name, type: v.type, exported: true, raw, linhasCount: linhas.length, sampleLines: linhas.slice(0,5) });
        } catch (err) {
          console.warn(`exportData failed for visual "${v.name}":`, err);
          results.push({ visualName: v.name, type: v.type, exported: false, error: err && err.message ? err.message : err });
        }
      }
      return results;
    }

    // 3) apply filter when loaded
    report.on("loaded", async () => {
      console.log("EVENT loaded");
      statusEl.style.display = "block";
      statusEl.innerText = "Aguarde, seu resultado fica pronto em breve... (inspecionando)";

      await applyCodigoFilter();
      await logReportFilters();
    });

    // 4) on rendered attempt inspection and, if empty, keep polling
    let polling = true;
    let attempts = 0;
    const maxAttempts = 40; // pare ap√≥s ~40 tentativas (configur√°vel)
    const intervalMs = 3000; // 3s entre tentativas

    async function checkOnce() {
      attempts++;
      console.log(`\n=== checkOnce attempt #${attempts} ===`);
      try {
        const filterState = await report.getFilters();
        console.log("Current report filters after update:", filterState);
      } catch(e) { console.warn("getFilters() error:", e); }

      const visualsReport = await inspectVisualsExport();

      // decide if any visual has data > 1 line (header + rows) 
      const anyData = visualsReport.some(r => r.exported && (r.linhasCount && r.linhasCount > 1));
      console.log("anyData?", anyData);

      if (anyData) {
        console.log("Dados encontrados ‚Äî escondendo mensagem.");
        statusEl.style.display = "none";
        polling = false;
        return;
      } else {
        console.log("Nenhum dado encontrado nessa checagem.");
        statusEl.style.display = "block";
        statusEl.innerText = "Aguarde, seu resultado fica pronto em breve...";
      }
    }

    // initial rendered handler triggers first check, then start polling if empty
    report.on("rendered", async () => {
      console.log("EVENT rendered");
      await checkOnce();

      // start polling loop if still empty
      const pollLoop = setInterval(async () => {
        if (!polling) { clearInterval(pollLoop); return; }
        if (attempts >= maxAttempts) {
          console.log("Max attempts reached ‚Äî parando polling.");
          statusEl.style.display = "block";
          statusEl.innerText = "Aguarde, seu resultado fica pronto em breve... (sem resultado ap√≥s v√°rias tentativas)";
          clearInterval(pollLoop);
          return;
        }
        await checkOnce();
      }, intervalMs);
    });

    // 5) simple error handler (log)
    report.on("error", e => {
      console.error("PowerBI embed error:", e);
      statusEl.style.display = "block";
      statusEl.innerText = "Erro ao carregar (ver console).";
    });

  } catch (err) {
    console.error("Erro no embedReport:", err);
    statusEl.style.display = "block";
    statusEl.innerText = "Erro ao iniciar a visualiza√ß√£o.";
  }
})();
</script>

</body>
</html>
